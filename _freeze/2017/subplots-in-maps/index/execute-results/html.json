{
  "hash": "909200a52400b4a8097b201e2caf7165",
  "result": {
    "markdown": "---\ntitle: \"Subplots in maps with ggplot2\"\ndescription-meta: \"{{< meta website.description >}}\"\ndate: \"2017-05-25\"\nimage: teaser.png\ncategories: [r, ggplot2, rspatial]\n---\n\n\n***\n\n\n\nFollowing the [surprising success][tw] of [my latest post][post], I decided to show yet another use case of the handy `ggplot2::annotation_custom()`. Here I will show how to add small graphical information to maps -- just like putting a stamp on an envelope.  \n\nThe example comes from my current work on a paper, in which I study the effect of urban/rural differences on the relative differences in population ageing (I plan to tell a bit more in one of the next posts). Let's have a look at the map we are going to reproduce in this post:\n\n![](map.png)\n\nSo, with this map I want to show the location of more and less urbanized NUTS-2 regions of Europe. But I also want to show -- with subplots -- how I defined the three subregions of Europe (Eastern, Southern, and Western) and what is the relative frequency of the three categories of regions (Predominantly Rural, Intermediate, and Predominantly Rural) within each of the subregions. The logic of actions is simple: first prepare all the components, then assemble them in a composite plot. Let's go!\n\nThe code to prepare R session and load the data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# additional packages\nlibrary(tidyverse)\nlibrary(ggthemes)\nlibrary(rgdal)\nlibrary(viridis)\nlibrary(RColorBrewer)\nlibrary(extrafont)\nmyfont <- \"Roboto Condensed\"\n\n# load the already prepared data\nload(url(\"https://ikashnitsky.github.io/share/1705-map-subplots/df-27-261-urb-rur.RData\"))\nload(url(\"https://ikashnitsky.github.io/share/1705-map-subplots/spatial-27-261.RData\"))\n```\n:::\n\n\nNow, I prepare the spatial objects to be plotted with ggplot2 and create a blank map of Europe -- our canvas.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# fortify spatial objects\nbord <- fortify(Sborders)\nfort <- fortify(Sn2, region = \"id\")\n\n# join spatial and statistical data\nfort_map <- left_join(df,fort,\"id\")\n\n# create a blank map\nbasemap <- ggplot()+\n        geom_polygon(data = fortify(Sneighbors),aes(x = long, y = lat, group = group),\n                     fill = \"grey90\",color = \"grey90\")+\n        coord_equal(ylim = c(1350000,5450000), xlim = c(2500000, 6600000))+\n        theme_map(base_family = myfont)+\n        theme(panel.border = element_rect(color = \"black\",size = .5,fill = NA),\n              legend.position = c(1, 1),\n              legend.justification = c(1, 1),\n              legend.background = element_rect(colour = NA, fill = NA),\n              legend.title = element_text(size = 15),\n              legend.text = element_text(size = 15))+\n        scale_x_continuous(expand = c(0,0)) +\n        scale_y_continuous(expand = c(0,0)) +\n        labs(x = NULL, y = NULL)\n```\n:::\n\n\n![](basemap.png)\n\nOkay, now the envelope is ready. It's time to prepare the stamps. Let's create a nice mosaic plot showing the distribution of NUTS-2 regions by subregions and the urb/rur categories. I found the simplest way to create a nice mosaic plot on [Stack Overflow][so]. \n\n\n::: {.cell}\n\n```{.r .cell-code}\n# create a nice mosaic plot; solution from SO:\n# http://stackoverflow.com/a/19252389/4638884\nmakeplot_mosaic <- function(data, x, y, ...){\n        xvar <- deparse(substitute(x))\n        yvar <- deparse(substitute(y))\n        mydata <- data[c(xvar, yvar)];\n        mytable <- table(mydata);\n        widths <- c(0, cumsum(apply(mytable, 1, sum)));\n        heights <- apply(mytable, 1, function(x){c(0, cumsum(x/sum(x)))});\n        \n        alldata <- data.frame();\n        allnames <- data.frame();\n        for(i in 1:nrow(mytable)){\n                for(j in 1:ncol(mytable)){\n                        alldata <- rbind(alldata, c(widths[i], \n                                                    widths[i+1], \n                                                    heights[j, i], \n                                                    heights[j+1, i]));\n                }\n        }\n        colnames(alldata) <- c(\"xmin\", \"xmax\", \"ymin\", \"ymax\")\n        \n        alldata[[xvar]] <- rep(dimnames(mytable)[[1]], \n                               rep(ncol(mytable), nrow(mytable)));\n        alldata[[yvar]] <- rep(dimnames(mytable)[[2]], nrow(mytable));\n        \n        ggplot(alldata, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax)) + \n                geom_rect(color=\"white\", aes_string(fill=yvar)) +\n                xlab(paste(xvar, \"(count)\")) + \n                ylab(paste(yvar, \"(proportion)\"));\n}\n\ntyp_mosaic <- makeplot_mosaic(data = df %>% mutate(type = as.numeric(type)), \n                              x = subregion, y = type)+\n        theme_void()+\n        scale_fill_viridis(option = \"B\", discrete = T, end = .8)+\n        scale_y_continuous(limits = c(0, 1.4))+\n        annotate(\"text\",x = c(27, 82.5, 186), y = 1.05, \n                 label=c(\"EAST\", \"SOUTH\", \"WEST\"), \n                 size = 4, fontface = 2, \n                 vjust = 0.5, hjust = 0,\n                 family = myfont) + \n        coord_flip()+\n        theme(legend.position = \"none\")\n```\n:::\n\n\n![](mosaic.png)\n\nJust what we needed. The next step is to build a small map showing the three subregions of Europe. But before we proceed to the maps, one thing has to be fixed. `ggplot2` [fails rendering nested polygons][poly]. With our regional dataset, London, for example, will not be shown if we do not account for this unpleasant feature.  Luckily, there is quite a simple [solution to fix that problem][fix].\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# a nice small function to overcome some mapping problems with nested polygons\n# see more at SO\n# https://stackoverflow.com/questions/21748852\ngghole <- function (fort) {\n        poly <- fort[fort$id %in% fort[fort$hole, ]$id, ]\n        hole <- fort[!fort$id %in% fort[fort$hole, ]$id, ]\n        out <- list(poly, hole)\n        names(out) <- c(\"poly\", \"hole\")\n        return(out)\n}\n```\n:::\n\n\nNow I build the small map of subregions.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# pal for the subregions\nbrbg3 <- brewer.pal(11,\"BrBG\")[c(8,2,11)]\n\n# annotate a small map of the subregions of Europe\nan_sub <- basemap +\n        geom_polygon(data = gghole(fort_map)[[1]], \n                     aes(x = long, y = lat, group = group, fill = subregion),\n                     color = NA)+\n        geom_polygon(data  =  gghole(fort_map)[[2]], \n                     aes(x = long, y = lat, group = group, fill = subregion),\n                     color = NA)+\n        scale_fill_manual(values = rev(brbg3)) +\n        theme(legend.position = \"none\")\n```\n:::\n\n\n![](sub.png)\n\nFinally, everything is ready to build the main map and stick the two subplots on top of it.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# finally the map of Urb/Rur typology\n\ncaption <- \"Classification: De Beer, J., Van Der Gaag, N., & Van Der Erf, R. (2014). New classification of urban and rural NUTS 2 regions in Europe. NIDI Working Papers, 2014/3. Retrieved from http://www.nidi.nl/shared/content/output/papers/nidi-wp-2014-03.pdf\n\\nIlya Kashnitsky (ikashnitsky.github.io)\"\n\ntyp <-  basemap + \n        \n        geom_polygon(data = gghole(fort_map)[[1]], \n                     aes(x=long, y=lat, group=group, fill=type),\n                     color=\"grey30\",size=.1)+\n        geom_polygon(data = gghole(fort_map)[[2]], \n                     aes(x=long, y=lat, group=group, fill=type),\n                     color=\"grey30\",size=.1)+\n        scale_fill_viridis(\"NEUJOBS\\nclassification of\\nNUTS-2 regions\", \n                           option = \"B\", discrete = T, end = .8)+\n        geom_path(data = bord, aes(x = long, y = lat, group = group),\n                  color = \"grey20\",size = .5) + \n        \n        annotation_custom(grob = ggplotGrob(typ_mosaic), \n                          xmin = 2500000, xmax = 4000000, \n                          ymin = 4450000, ymax = 5450000)+\n        annotation_custom(grob = ggplotGrob(an_sub), \n                          xmin = 5400000, xmax = 6600000, \n                          ymin = 2950000, ymax = 4150000)+\n        labs(title = \"Urban / Rural classification of NUTS-2 regions of Europe\\n\",\n             caption = paste(strwrap(caption, width = 95), collapse = '\\n'))+\n        theme(plot.title = element_text(size = 20),\n              plot.caption = element_text(size = 12))\n```\n:::\n\n\n![](map.png)\n\nDone!\n\nOf course, it takes several iterations to position each element in its proper place. Then, one also needs to play with export parameters to finally get the desired output.\n\n***\n\n::: {.callout-tip}\n# The full R script for this post is [here][code]\n:::\n\n\n\n\n[tw]: https://ikashnitsky.github.io/images/170525/prev-post-success.png\n[post]: https://ikashnitsky.github.io/2017/align-six-maps/\n[so]: http://stackoverflow.com/a/19252389/4638884\n[poly]: https://stackoverflow.com/questions/21748852\n[fix]: https://stackoverflow.com/a/32186989/4638884\n[code]: https://ikashnitsky.github.io/share/1705-map-subplots/code.R\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}