{
  "hash": "e0350d5e3fcb6e7a58f83098a810773c",
  "result": {
    "markdown": "---\ntitle: \"Data acquisition in R (3/4)\"\ndescription-meta: \"{{< meta website.description >}}\"\ndate: \"2017-12-10\"\nimage: teaser.png\ncategories: [r, tutorial, data acquisition]\n---\n\n\n***\n\n\n\n::: {.callout-note}\n# The series consists of four posts:\n - [Loading prepared datasets][one]\n - [Accessing popular statistical databases][two]\n - **Demographic data sources**\n - Getting spatial data\n:::\n\n \nFor each of the data acquisition options I provide a small visualization use case.\n\n\n\n# Human Mortality Database\n\nWhen it comes to testing the big questions of human population dynamics, there is no more reliable data source than [Human Mortality Database][hmd]. This database is run by demographers who use state-of-the-art methodology to overcome issues in the data. As the result, the estimates are as precise as possible. Their [methods protocol][pro] is a masterpiece of demographic data processing. On the down side, the data of decent enough quality is available for only a bunch of countries. To explore the data I highly recommend [Human Mortality Database Explorer][exp] by [Jonas Schöley][jonas].\n\nThanks to [Tim Riffe][tim]’s `HMDHFDplus` package, one can now download HMD data with just a couple of lines of `R` code. Please note that an account at [mortality.org][hmd] is needed in order to download data. As one may guess from the package name, it also helps to grab data from equally brilliant [Human Fertility Database][hfd].  \n\nThe following example is taken from my [earlier post][post] (and updated a bit). I think it illustrates nicely the power of automated data acquisition in `R`. Here I am going to download one year population population structures for both males and females for each single country of HMD. If you want to reproduce the result, beware that the script will download a couple of dozens megabits of data. Then I will calculate and visualize as small multiples sex ratios in all countries along age dimension. Sex ratios reflect the two basic regularities of human demographics: 1) there are always more boys being born; 2) males experience higher mortality throughout their life-course. Besides some artificial and well known exceptions, sex ratio at birth does not vary dramatically and is more or less constant at the level of 105-106 boys per 100 girls. Hence, differences in the sex ratio profiles of countries mainly reflect gender gap in mortality.    \n\n\n::: {.cell}\n\n```{.r .cell-code}\n# load required packages\nlibrary(HMDHFDplus)\nlibrary(tidyverse)\nlibrary(purrr)\n\n\n# help function to list the available countries\ncountry <- getHMDcountries()\n\n# remove optional populations\nopt_pop <- c(\"FRACNP\", \"DEUTE\", \"DEUTW\", \"GBRCENW\", \"GBR_NP\")\ncountry <- country[!country %in% opt_pop]\n\n# temporary function to download HMD data for a simgle county (dot = input)\ntempf_get_hmd <- . |> readHMDweb(\"Exposures_1x1\", ik_user_hmd, ik_pass_hmd) \n\n\n# download the data iteratively for all countries using purrr::map()\nexposures <- country |> map(tempf_get_hmd)\n\n# data transformation to apply to each county dataframe\ntempf_trans_data <- . |> \n        select(Year, Age, Female, Male) |> \n        filter(Year %in% 2012) |>\n        select(-Year) |>\n        transmute(age = Age, ratio = Male / Female * 100)\n\n# perform transformation\ndf_hmd <- exposures |> \n        map(tempf_trans_data) |> \n        bind_rows(.id = \"country\")\n\n# summarize all ages older than 90 (too jerky)\ndf_hmd_90 <- df_hmd |> \n        filter(age %in% 90:110) |> \n        group_by(country) |> \n        summarise(ratio = ratio |> mean(na.rm = T)) |>\n        ungroup() |> \n        transmute(country, age = 90, ratio)\n\n# insert summarized 90+\ndf_hmd_fin <- bind_rows(df_hmd |> filter(!age %in% 90:110), df_hmd_90)\n\n# finaly - plot\ndf_hmd_fin |>  \n        ggplot(aes(age, ratio, color = country, group = country))+\n        geom_hline(yintercept = 100, color = \"grey50\", size = 1)+\n        geom_line(size = 1)+\n        scale_y_continuous(limits = c(0, 120), \n                           expand = c(0, 0), \n                           breaks = seq(0, 120, 20))+\n        scale_x_continuous(limits = c(0, 90), \n                           expand = c(0, 0), \n                           breaks = seq(0, 80, 20))+\n        facet_wrap(~country, ncol = 6)+\n        theme_minimal(base_family = \"mono\", base_size = 15)+\n        theme(legend.position = \"none\",\n              panel.border = element_rect(size = .5, fill = NA, \n                                          color = \"grey50\"))+\n        labs(x = \"Age\", \n             y = \"Sex ratio, males per 100 females\", \n             title = \"Sex ratio in all countries from Human Mortality Database\",\n             subtitle = \"HMD 2012, via HMDHFDplus by @timriffe1\",\n             caption = \"ikashnitsky.github.io\")\n```\n:::\n\n\n\n![](hmd.png)\n\n\n# United Nations World Population Prospects\n\nPopulation Department of the United Nations provides high quality population estimates for all countries of the world. They update estimates every 2-3 years and publish openly as an interactive report [World Population Prospects][wpp]. One may find in these reports key highlights and, of course, rich data. The data is later wrapped in `R` packages called `wpp20xx`. Currently, the available packages are for the estimate updates 2008, 2010, 2012, 2015, and 2017. I will give here an example of `wpp2015` use adapted from my earlier [post][e0conv]. \n\nUsing ridgeplot, the amazing type of dataviz promoted `ggridges` package by [Claus Wilke][wilke], I am going to show the impressive reduction of global inequality in male mortality that took place since 1950.   \n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(wpp2015)\nlibrary(tidyverse)\nlibrary(ggridges)\nlibrary(viridis)\n\n# get the UN country names\ndata(UNlocations)\n\ncountries <- UNlocations |> pull(name) |> paste\n\n# data on male life expectancy at birth\ndata(e0M) \n\ne0M |> \n        filter(country %in% countries) |> \n        select(-last.observed) |> \n        gather(period, value, 3:15) |> \n        ggplot(aes(x = value, y = period |> fct_rev()))+\n        geom_density_ridges(aes(fill = period))+\n        scale_fill_viridis(discrete = T, option = \"B\", direction = -1, \n                           begin = .1, end = .9)+\n        labs(x = \"Male life expectancy at birth\",\n             y = \"Period\",\n             title = \"Global convergence in male life expectancy at birth since 1950\",\n             subtitle = \"UNPD World Population Prospects 2015 Revision, via wpp2015\",\n             caption = \"ikashnitsky.github.io\")+\n        theme_minimal(base_family =  \"mono\")+\n        theme(legend.position = \"none\")\n```\n:::\n\n\n![](wpp2015.png)\n\n\n\n# European Social Survey (ESS)\n\n[European Social Survey][ess] provides uniquely rich nationally representative cross-county comparable information on the values of Europeans. Every two years a cross-sectional sample is taken in each participating country. All the data is easily available [upon registration][essreg]. Datasets are distributed as SAS, SPSS, or STATA files. Thanks to [Jorge Cimentada][jorge], these datasets are now easily available via `ess` package. I am going to visualize how respondents assessed their level of trust in police in all available countries at the latest round of the survey.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ess)\nlibrary(tidyverse) \n\n# help gunction to see the available countries\nshow_countries()\n\n# check the available rounds for a selected country\nshow_country_rounds(\"Netherlands\")\n\n# get the full dataset of the last (8) round\ndf_ess <- ess_rounds(8, your_email =  ik_email) \n\n# select a variable and calculate mean value\ndf_ess_select <- df_ess |> \n        bind_rows() |> \n        select(idno, cntry, trstplc) |> \n        group_by(cntry) |> \n        mutate(avg = trstplc |> mean(na.rm = T)) |> \n        ungroup() |> \n        mutate(cntry = cntry |> as_factor() |> fct_reorder(avg))\n\ndf_ess_select |> \n        ggplot(aes(trstplc, fill = avg))+\n        geom_histogram()+\n        scale_x_continuous(limits = c(0, 11), breaks = seq(2, 10, 2))+\n        scale_fill_gradient(\"Average\\ntrust\\nscore\", \n                            low = \"black\", high = \"aquamarine\")+\n        facet_wrap(~cntry, ncol = 6)+\n        theme_minimal(base_family = \"mono\")+\n        labs(x = \"Trust score [0 -- 10]\",\n             y = \"# of respondents\",\n             title = \"Trust in police\",\n             subtitle = \"ESS wave 8 2017, via ess by @cimentadaj\",\n             caption = \"ikashnitsky.github.io\")\n```\n:::\n\n\n\n![](ess.png)\n\n\n\n# American Community Survey and Census\n\nThere are several packages that provide access to the US Census and ACS data. Perhaps the most convenient one is the recent `tidycensus` package by [Kyle Walker][kyle]. One extremely useful feature of this approach is the ability to download geodata along with stats in the form of simple features. Simple features, a revolutionary approach to deal with spatial data in R implemented in `sf` package by [Edzer Pebesma][edz], allow to manage and visualize geodata tidy and efficiently. Note that in order to reproduce the following example one would have to install the development version of ggplot2. \n\nBelow I map median ages of census tracts population in Chicago based on the ACS estimates in 2015. To use `tidycensus`, an API key is required. API is instantly provided [upon registration][api].\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidycensus)\nlibrary(tidyverse)\nlibrary(viridis)\nlibrary(janitor)\nlibrary(sf)\n# to use geom_sf we need the latest development version of ggplot2\ndevtools::install_github(\"tidyverse/ggplot2\", \"develop\")\nlibrary(ggplot2)\n\n\n# you need a personal API key, available free at\n# https://api.census.gov/data/key_signup.html\n# normally, this key is to be stored in .Renviron\n\n# see state and county codes and names\nfips_codes |> View\n\n# the available variables\nload_variables(year = 2015, dataset = \"acs5\") |> View\n\n# data on median age of population in Chicago\ndf_acs <- get_acs(\n        geography = \"tract\",\n        county = \"Cook County\",\n        state = \"IL\",\n        variables = \"B01002_001E\",\n        year = 2015,\n        key = ik_api_acs,\n        geometry = TRUE\n) |> clean_names()\n\n\n# map the data\ndf_acs |> \n        ggplot()+\n        geom_sf(aes(fill = estimate |> \n                            cut(breaks = seq(20, 60, 10))), \n                color = NA)+\n        scale_fill_viridis_d(\"Median age\", begin = .4)+\n        coord_sf(datum = NA)+\n        theme_void(base_family =  \"mono\")+\n        theme(legend.position = c(.15, .15))+\n        labs(title = \"Median age of population in Chicago\\nby census tracts\\n\",\n             subtitle = \"ACS 2015, via tidycensus by @kyle_e_walker\",\n             caption = \"ikashnitsky.github.io\", \n             x = NULL, y = NULL)\n```\n:::\n\n\n\n![](tidycensus.png)\n\n***\n\n::: {.callout-tip}\nAll the code chunks together can be found in [this gist][gist]\n:::\n\n\n[odata]: https://github.com/ropensci/opendata\n[one]: https://ikashnitsky.github.io/2017/data-acquisition-one/\n[two]: https://ikashnitsky.github.io/2017/data-acquisition-two\n[hmd]: http://www.mortality.org\n[tim]: https://twitter.com/timriffe1\n[hfd]: http://www.humanfertility.org/\n[pro]: http://www.mortality.org/Public/Docs/MethodsProtocol.pdf\n[jonas]: https://twitter.com/jschoeley\n[tim]: https://twitter.com/timriffe1\n[post]: https://ikashnitsky.github.io/2017/hmd-all-sex-ratio/\n[wpp]: https://esa.un.org/unpd/wpp/\n[e0conv]: https://ikashnitsky.github.io/2017/global-male-life-expectancy-convergence/\n[wilke]: https://twitter.com/ClausWilke\n[ess]: http://www.europeansocialsurvey.org/about/\n[essreg]: http://www.europeansocialsurvey.org/user/new\n[jorge]: https://twitter.com/cimentadaj\n[kyle]: https://twitter.com/kyle_e_walker\n[edz]: https://twitter.com/edzerpebesma\n[api]: https://api.census.gov/data/key_signup.html\n\n[gist]: https://gist.github.com/ikashnitsky/2e4bb16e097b1a264eeeae13ca6d7ce3\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}