{
  "hash": "420184fe670d72b9b9c0f54b8e914fd1",
  "result": {
    "markdown": "---\ntitle: \"Hacking maps with ggplot2\"\ndescription-meta: \"{{< meta website.description >}}\"\ndate: \"2017-04-24\"\nimage: teaser.png\ncategories: [r, ggplot2, rspatial]\n---\n\n\n***\n\n\nThis is a very short post on mapping with `ggplot2`.   \n\nQuite often, mapping some data, we do not need to follow scrupulously the formal requirements to geographical maps -- the idea is just to show the spatial dimension of the data. For instance, the network of rivers is not the most important information when we [map the elections outcome][ele]. Thus, the simplified mapping allows quite some freedom in transforming the geodata. The classical example of such geodata transformation is the [replacement and scaling of Alaska and Hawaii][ala] to be mapped alongside the mainland of the US. As one may see in this example, usually such geodata transformations utilize quite complex GIS tools in order to reposition an object in the coordinate system.  \n\nThe interesting feature of mapping with `ggplot2` is that, before the actual plotting, geodata has to be fotrified (`ggplot2::fortify`) -- transformed to a simple dataframe object. Since fortified geodata is basically a dataframe, some simple transformations could be made really easily.   \n\nIn my last [paper][osf], I needed to show a two-dimensional grouping of the European NUTS-2 regions in 4 quadrants according to GDP per capita and the share of working-age population (see Figure 8 in the [preprint][pre]). In line with the study setting, I did the grouping separately for Western, Southern, and Eastern Europe. I decided that the most straightforward way to show that on map would be to visually separate the 3 subregions of Europe. The task is easily doable through triggering the fortified geodata object -- see the code below. \n\nFirst, the code to prepare the R session and load the (already prepared) data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse) # version 1.1.1\nlibrary(extrafont) # version 0.17\nlibrary(ggthemes) # version 3.4.0\nfont <- \"Roboto Condensed\"\nlibrary(hrbrthemes) # version 0.1.0\n# The code is tested on a PC-win7-x64\n# R version 3.3.3\n\n\n# load the prepared geodata and stat data\nload(url(\"https://ikashnitsky.github.io/share/1704-map-hacking/map-hacking.Rdata\"))\n\n# fortify the spatial objects\nbord <- fortify(Sborders)\nfort <- fortify(Sn2, region = 'id')\n```\n:::\n\n\nNext, I hack the geodata (`long` and `lat` variables) moving groups of NUTS-2 regions (Western, Southern, and Eastern Europe) apart. The appropriate values to move the groups of regions were found empirically. \n\n\n::: {.cell}\n\n```{.r .cell-code}\n# hack geodata to separate macro-regions\nfort_hack <- fort |> \n        left_join(df |> select(id, subregion), 'id') |> \n        mutate(long = ifelse(subregion=='E', long + 5e5, long),\n               long = ifelse(subregion=='S', long + 2e5, long),\n               lat = ifelse(subregion=='S', lat - 5e5, lat),\n               long = ifelse(subregion=='W', long - 2e5, long))\n```\n:::\n\n\nFinally, we are ready to create the schematic map. \n\n\n::: {.cell}\n\n```{.r .cell-code}\n# create color pallete\nbrbg <- RColorBrewer::brewer.pal(11,\"BrBG\")\nbrbg4 <- brbg[c(4,9,2,11)]\n\n# create the two-dim legend\nggleg <- ggplot()+\n        coord_equal(xlim = c(0,1), ylim = c(0,1), expand = c(0,0))+\n        annotate('rect', xmin = .45, xmax = .6, ymin = .1, ymax = .25, \n                 fill = brbg4[1], color = NA)+\n        annotate('rect', xmin = .45, xmax = .6, ymin = .4, ymax = .55, \n                 fill = brbg4[2], color = NA)+\n        annotate('rect', xmin = .75, xmax = .9, ymin = .1, ymax = .25, \n                 fill = brbg4[3], color = NA)+\n        annotate('rect', xmin = .75, xmax = .9, ymin = .4, ymax = .55, \n                 fill = brbg4[4], color = NA)+\n        annotate('rect', xmin = .05, xmax = .95, ymin = .05, ymax = .95, \n                 fill = NA, color = \"grey20\")+\n        \n        annotate('text', x = .35, y = c(.175, .475), vjust = .5, hjust = 1,\n                 size = 6, fontface = 2, label = c('POOR', 'RICH'), family = font) + \n        annotate('text', x = c(.525, .825), y = .65, vjust = 0, hjust = .5,\n                 size = 6, fontface = 2, label = c('LOW', 'HIGH'), family = font)+\n        annotate('text', x = .1, y = .9, vjust = 1, hjust = 0,\n                 size = 7, fontface = 2, label = \"LEGEND\", family = font)+\n        theme_map()\n\n# create the blank map\nbasemap <- ggplot()+\n        coord_equal(\n            ylim=c(900000,5400000), xlim=c(2500000, 7000000), expand = c(0,0)\n        )+\n        theme_map()+\n        theme(panel.border=element_rect(color = 'black',size=.5,fill = NA),\n              legend.position = 'none')\n\n# the main map\nmap_temp <- basemap + \n        geom_map(map = fort_hack, data = df, aes(map_id=id, fill=group))+\n        scale_fill_manual(values = brbg4[c(3, 1, 4, 2)])\n\n# now combine the map and the legend\nmap <- ggplot() + \n        coord_equal(xlim = c(0,1), ylim = c(0,1), expand = c(0,0))+\n        annotation_custom(\n            ggplotGrob(map_temp), xmin = 0, xmax = 1, ymin = 0, ymax = 1\n        )+\n        annotation_custom(\n            ggplotGrob(ggleg), xmin = 0.72, xmax = 0.99, ymin = 0.72, ymax = 0.99\n        )+\n        labs(\n            title = \"Labour force and income in EU-27 NUTS-2 regions\",\n            subtitle = \"Within each of the three macro-regions of Europe - Westren, \n             Southern, and Eastern -\\nNUTS-2 regions are classified in 4 groups \n             according to the level of GDP per capita\\nand the share of working \n             age population in 2008\",\n            caption = \"Data: Eurostat\\nAuthor: Ilya Kashnitsky (ikashnitsky.github.io)\"\n        )+\n        theme_ipsum_rc(plot_title_size = 30, subtitle_size = 20, caption_size = 15)\n```\n:::\n\n\nAnd here is the result.\n\n***  \n\n![](hacked-map.png)\n\n\n***\n\n\n[ele]: https://twitter.com/data_debunk/status/856251551970717698\n[ala]: https://rpubs.com/technocrat/thematic-alaska-hawaii\n[osf]: https://osf.io/suwxf/\n[pre]: https://ikashnitsky.github.io/doc/pubs/1702-nidi-wp-ik.pdf\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}