{
  "hash": "a7d5d9c995543063cf82da6383c61e6a",
  "result": {
    "markdown": "---\ntitle: \"Data acquisition in R (2/4)\"\ndescription-meta: \"{{< meta website.description >}}\"\ndate: \"2017-11-07\"\nimage: teaser.png\ncategories: [r, tutorial, data acquisition]\n---\n\n\n***\n\n::: {.callout-note}\n# The series consists of four posts:\n - [Loading prepared datasets][one]  \n - **Accessing popular statistical databases**  \n - [Demographic data sources][three]  \n - Getting spatial data  \n:::\n\nFor each of the data acquisition options I provide a small visualization use case.\n\n# Eurostat\n\nThe package `eurostat` has a function `search_eurostat` to search for the relevant datasets. Though, sadly enough, this function does not provide the codes of all the datasets that has the expression of interest in the title. For example, the search on the expression `life expectancy` produces an output with just 2 results, which does not make any sense. Thus, the best strategy is to go to [Eurostat website][estat], find the needed dataset code, and fetch the desired dataset by its code. Note that there is a [separate database for subregional level indicators][esreg]. \n\nI am going to download life expectancy estimates for European countries; the dataset code is `demo_mlexpec`. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse) \nlibrary(lubridate)\nlibrary(eurostat) \n\n# download the selected dataset\ne0 <- get_eurostat(\"demo_mlexpec\")\n```\n:::\n\n\nIt can take a while because the dataset is quite big (0.4m obs). If the automated procedure does not work, one can download the data manually via the [Bulk Download Service][bulk] of Eurostat.  \n\nLet's have a look at the remaining life expectancy at age 65, the most common conventional age at retirement, in some European countries, separately for males, females, and total population. Some data preparation steps are needed. First, we only need the life expectancy  estimates for those aged 65. Next, we don't need total population, only males and females separately. Finally, let's select just a bunch of countries: Germany, France, Italy, Russia, Spain, the UK.  \n\n\n::: {.cell}\n\n```{.r .cell-code}\ne0 |> \n        filter(! sex == \"T\",\n               age == \"Y65\", \n               geo %in% c(\"DE\", \"FR\", \"IT\", \"RU\", \"ES\", \"UK\")) |> \n        ggplot(aes(x = time |> year(), y = values, color = sex))+\n        geom_path()+\n        facet_wrap(~ geo, ncol = 3)+\n        labs(y = \"Life expectancy at age 65\", x = NULL)+\n        theme_minimal(base_family = \"mono\")\n```\n:::\n\n\n![](eurostat.png)\n\n\n# World Bank\n\nThere are several packages that provide an API to World Bank data. Probably, the most elaborated one is a fairly recent [`wbstats`][wbstats]. Its `wbsearch` function really does great job searching through the database for the relevant datasets. For example, `wbsearch(\"fertility\")` produces a dataframe of 339 entries with the codes and names of the relevant indicators. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse) \nlibrary(wbstats)\n\n# search for a dataset of interest\nwbsearch(\"fertility\") |> head\n```\n:::\n\n\n\n|     |indicatorID    |indicator                                                    |\n|:----|:--------------|:------------------------------------------------------------|\n|2479 |SP.DYN.WFRT.Q5 |Total wanted fertility rate (births per woman): Q5 (highest) |\n|2480 |SP.DYN.WFRT.Q4 |Total wanted fertility rate (births per woman): Q4           |\n|2481 |SP.DYN.WFRT.Q3 |Total wanted fertility rate (births per woman): Q3           |\n|2482 |SP.DYN.WFRT.Q2 |Total wanted fertility rate (births per woman): Q2           |\n|2483 |SP.DYN.WFRT.Q1 |Total wanted fertility rate (births per woman): Q1 (lowest)  |\n|2484 |SP.DYN.WFRT    |Wanted fertility rate (births per woman)                     |\n\n\nLet's have a look at the indicator `Lifetime risk of maternal death (%)` (code `SH.MMR.RISK.ZS`). World Bank provides a variety of country groupings. One of the curious groupings divides countries based on the advance over the Demographic Transition path. Below I plot our selected indicator for (1) the countries that have passed the Demographic Transition, (2) the countries that haven't yet experienced demographic dividend, and (3) the whole World. \n\n\n::: {.cell}\n\n```{.r .cell-code}\n# fetch the selected dataset\ndf_wb <- wb(indicator = \"SH.MMR.RISK.ZS\", startdate = 2000, enddate = 2015)\n\n# have look at the data for one year\ndf_wb |> filter(date == 2015) |> View\n\ndf_wb |> \n        filter(iso2c %in% c(\"V4\", \"V1\", \"1W\")) |> \n        ggplot(aes(x = date |> as.numeric(), y = value, color = country))+\n        geom_path(size = 1)+\n        scale_color_brewer(NULL, palette = \"Dark2\")+\n        labs(x = NULL, y = NULL, title = \"Lifetime risk of maternal death (%)\")+\n        theme_minimal(base_family = \"mono\")+\n        theme(panel.grid.minor = element_blank(),\n              legend.position = c(.8, .9))\n```\n:::\n\n\n![](worldbank.png)\n\n# OECD\n\nOrganization for Economic Cooperation and Development provides detailed economic and demographic data on the member countries. There is an R package `OECD` that streamlines the use of their data in R. The function `search_dataset` works nicely to browse the available datasets by keywords. Then `get_dataset` would fetch the chosen dataset. In the example below I grab the data on the duration of unemployment and then plot the data for the male population of EU16, EU28 and the US as heatmaps.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse) \nlibrary(viridis)\nlibrary(OECD)\n\n# search by keyword\nsearch_dataset(\"unemployment\") |> View\n\n# download the selected dataset\ndf_oecd <- get_dataset(\"AVD_DUR\")\n\n# turn variable names to lowercase\nnames(df_oecd) <- names(df_oecd) |> tolower()\n\ndf_oecd |> \n        filter(\n            country %in% c(\"EU16\", \"EU28\", \"USA\"), sex == \"MEN\", ! age == \"1524\"\n        ) |> \n        ggplot(aes(obstime, age, fill = obsvalue))+\n        geom_tile()+\n        scale_fill_viridis(\"Months\", option = \"B\")+\n        scale_x_discrete(breaks = seq(1970, 2015, 5) |> paste)+\n        facet_wrap(~ country, ncol = 1)+\n        labs(x = NULL, y = \"Age groups\", \n             title = \"Average duration of unemployment in months, males\")+\n        theme_minimal(base_family = \"mono\")\n```\n:::\n\n\n![](oecd.png)\n\n\n# WID\n\n[World Wealth and Income Database][wid] is a harmonized dataset on income and wealth inequality. The developers of the database provide an R package to get their data, which is only [available from github][widr] so far. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse) \n\n#install.packages(\"devtools\")\ndevtools::install_github(\"WIDworld/wid-r-tool\")\nlibrary(wid)\n```\n:::\n\n\nThe function to acquire data is `download_wid()`. To specify the arguments, one would have to consult help pages of the package and select desired datasets.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n?wid_series_type\n?wid_concepts\n```\n:::\n\n\nThe following nice example is adapted from [the package vignette][vig]. It shows the share of wealth that was owned by the richest 1% and 10% of population in France and Great Britain.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_wid <- download_wid(\n        indicators = \"shweal\", # Shares of personal wealth\n        areas = c(\"FR\", \"GB\"), # In France an Italy\n        perc = c(\"p90p100\", \"p99p100\") # Top 1% and top 10%\n)\n\n\ndf_wid |> \n        ggplot(aes(x = year, y = value, color = country)) +\n        geom_path()+\n        labs(\n            title = \"Top 1% and top 10% personal wealth shares in \n            France and Great Britain\",\n             y = \"top share\"\n        )+\n        facet_wrap(~ percentile)+\n        theme_minimal(base_family = \"mono\")\n```\n:::\n\n\n![](wid.png)\n\n\n***\n\n::: {.callout-tip}\n# All the code chunks together can be found in [this gist][gist]\n:::\n\n\n\n\n[odata]: https://github.com/ropensci/opendata\n[one]: https://ikashnitsky.github.io/2017/data-acquisition-one/\n[three]: https://ikashnitsky.github.io/2017/data-acquisition-three\n[estat]: http://ec.europa.eu/eurostat/data/database\n[esreg]: http://ec.europa.eu/eurostat/web/regions/data/database\n[bulk]: http://ec.europa.eu/eurostat/estat-navtree-portlet-prod/BulkDownloadListing\n[wbstats]: https://cran.r-project.org/web/packages/wbstats/README.html\n[wid]: http://wid.world/wid-world/\n[widr]: https://github.com/WIDworld/wid-r-tool\n[vig]: https://github.com/WIDworld/wid-r-tool/raw/master/inst/doc/wid-demo.pdf\n[gist]: https://gist.github.com/ikashnitsky/2362ce308f47ff38c3da556384acd20f\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}